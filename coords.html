<!DOCTYPE html>
<html>
  <head>
    <title>CodeCanvas</title>
    
  </head>
  <body>
  	<button id="submit" onclick="sendToBackEnd()">Submit</button>
  	<button id="clearAll" onclick="clearAll()">Clear All</button>
    <script>
      var isMouseDown = false;
      var mouseWasClickedHere;
      var isDrawing = false;
      var ctx;
      var points = {};
      var keys = [];


      function clearAll(){
      	for(var i = 0; i < keys.length;i++){
      		points[keys[i]] = [];
      		var c = document.getElementById("c_"+keys[i]);
      		//alert("c_"+keys[i]);
      		var con  = c.getContext("2d");
      		con.clearRect(0, 0, c.width, c.height);
      	}
      }

      function listOfListsOfCoordinatesAsString(list) {
      var ret = "";
      var coords;
      for(var i = 0; i < list.length; i++) {
			 for(var j = 0; j < list[i].length; j++) {
					    coords = list[i][j].x + "," + list[i][j].y + " ";
					    ret += coords;
					    }
					    ret = ret.concat("\n");
			 }
      return ret;
      }
      
      function sendToBackEnd(){
      	var list = getList();
					    var str = listOfListsOfCoordinatesAsString(list);
					    //document.getElementById("coords").innerHTML = "<code>" + str + "</code>";
					    //console.log(str);
					    //alert(str);
      //alert("Sending to back end!");
					    //var socket = new WebSocket(/*URL, protocol*/);
					    /**socket.onopen = function(event) {
					    socket.send(str);
					    };
					    socket.onmessage = function(event) {
					    //do something here
					    }*/
      }
      
      function addDownHandler(obj) {
      obj.addEventListener("mousedown", function(e){var xPosition = e.clientX - obj.getBoundingClientRect().left;
      var yPosition = e.clientY - obj.getBoundingClientRect().top;
      //obj.innerHTML = "down:" + xPosition + " " + yPosition;
      isMouseDown = true;
      var coords = "Coordinates: (" + e.clientX + ", " + e.clientY + ") -> ";
      document.getElementById("coords").innerHTML = coords;
      mouseWasClickedHere = obj;
      ctx = document.getElementById("c_"+obj.id).getContext("2d");
      isDrawing = true;
      ctx.moveTo(xPosition, yPosition);
      //points[points.length] = {x: xPosition, y: yPosition};
      points[obj.id][points[obj.id].length] = {x: xPosition, y: yPosition};
      ctx.stroke();
      });
      }
      
      function addMoveHandler(obj){
     
      obj.addEventListener("mousemove", function(e){var xPosition = e.clientX - obj.getBoundingClientRect().left;
      var yPosition = e.clientY - obj.getBoundingClientRect().top;
      if(isMouseDown){
      if(mouseWasClickedHere === obj) {
      
      if(isDrawing) {
      
      ctx.lineTo(xPosition, yPosition);
      
      ctx.stroke();
   
      }
      }
      var coords = "(" + e.clientX + ", " + e.clientY + ") -> ";
      document.getElementById("coords").innerHTML += coords;
      points[obj.id][points[obj.id].length] = {x: xPosition, y: yPosition};
      }
      });
      }
      function getPoints(obj) {
      var ret = "";
      var counter = 0;
      for(counter = 0; counter < points[obj.id].length; counter++) {
				 var coords = "(" + points[obj.id][counter].x + ", " + points[obj.id][counter].y + ") ";
				 ret += coords;
				 }
				 return ret;
      }
      function getListString(){
      	var ret = "";
      	for (var i = 0; i < keys.length;i++){
      		ret+= listAsString(points[keys[i]]);
      	}
      	return ret;
      }
      function getList() {
      	var ret = [];
      	for(var i = 0; i < keys.length; i++) {
      		ret[i] = points[keys[i]];
      	}
      	return ret;
      }
      function listAsString(lst) {
      	var ret = "";
      	for(var i = 0; i < lst.length; i++) {
      		var coords = "(" + lst[i].x + ", " + lst[i].y + ") ";
      		ret += coords;
      	}
      	return ret;
      }
      
      function addUpHandler(obj) {
      obj.addEventListener("mouseup", function(e){
      var xPosition = e.clientX - obj.getBoundingClientRect().left;
      var yPosition = e.clientY - obj.getBoundingClientRect().top;
      isMouseDown = false;
      if(obj === mouseWasClickedHere) {
      
      	if(isDrawing) {
      
      		ctx.lineTo(xPosition, yPosition);
      		ctx.stroke();
      		alert(getPoints(obj));
      		//alert(getListString());
      }
      }
      var coords = "(" + e.clientX + ", " + e.clientY + ").";
      document.getElementById("coords").innerHTML += coords;
      isDrawing = false;
      });
      
      }
      
      var table = document.createElement('TABLE');
      table.border='1';
      
      var tableBody = document.createElement('TBODY');
      table.appendChild(tableBody);
      
      for (var i=0; i<10; i++){
			  var tr = document.createElement('TR');
			  tr.id = "row " + i.toString();
			  tableBody.appendChild(tr);
			  
			  for (var j=0; j<10; j++){
					      var td = document.createElement('TD');
					      td.width='50';
					      td.height = '50';
					      tr.appendChild(td);
					      td.id = i.toString() + "_" + j.toString();
					      var canvasHTML = "<canvas id=\"c_"+i.toString()+"_"+j.toString()+"\" width=\"50\" height=\"50\"></canvas>";
					      td.innerHTML = canvasHTML;
					      points[td.id] = [];
					      keys[keys.length] = td.id;
					      addDownHandler(td);
					      addUpHandler(td);
					      addMoveHandler(td);
					      }
					      }
    	document.body.appendChild(table);
					      
					      
					      </script>
    
    <p id="coords">Coordinates: </p>
  </body>
</html>
